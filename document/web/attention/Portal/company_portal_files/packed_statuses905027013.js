function Status(a,b){this.id=b;this.$node=a;this.$others=this.$node.find(".others");this.$actions=this.$node.find(".actions");this.$text=this.$node.find(".comment-text");this.count_tmpl='<span class="count {cls}-count">({total})</span>';return this}Status.prototype={constructor:Status,init:function(){this.bindActionsEvents();this.bindUploadEvents()},updateCount:function(e,b,f){var d,a=e.next(".count");var c=a.attr("data-count")|0;if((c||f)&&(d=c+f)){a.remove();e.after($(this.count_tmpl.replace(/{cls}/g,b).replace(/{total}/g,d)));a=e.next(".count");a.attr("data-count",d)}else{a.remove()}},bindUploadEvents:function(){this.$node.find(".upload-pic").toggle(function(){var b=this.getAttribute("data-median-src");var a=this.getAttribute("data-raw-src");var d='<div class="attachment-ft"><a href="'+a+'" target="_blank">查看原图</a></div>';var e=this;$(this).css("opacity","0.5").parent().addClass("upload-pic-preview");var c=new Image();c.src=b;c.onload=function(){e.src=this.src;$(e).removeClass("big").addClass("small").css("opacity","1").parent().after(d)}},function(){var b=$(this);var c=$(window);var a=b.height()>c.height();b.css({width:"auto",height:"auto"}).attr("src",this.getAttribute("data-median-src").replace(/median/g,"small")).removeClass("small").addClass("big").parent().removeClass("upload-pic-preview").nextAll().remove();if(a){c.scrollTop(b.closest(".status-item").offset().top)}})},bindActionsEvents:function(){var a=this;this.$node.delegate(".btn","click",function(c){c.preventDefault();var b=$(this).attr("data-action-type");a[b]($(c.target))}).delegate(".add-more-comments","click",function(b){b.preventDefault();$(this).parent().removeClass("comment-posted").find(".comment-text").focus()}).find("form").bind("submit",function(b){b.preventDefault();if(!$.trim($(this).find(".comment-text").val())){return}a.addComment()})},getAllCommenters:function getReplyUsers(){var a=[];var b={};if(window.crt_uid){b[window.crt_uid]=1}$("a.commenter",this.$comments[0]).each(function(e,f){var d=f.href.split("/");var c=d[d.length-2];if(!(c in b)){a.push({uid:c,avatar:f.getAttribute("data-avatar"),username:f.innerHTML});b[c]=1}});this.commenters=a},filteredCommenters:function(c,b,h){var f=this.commenters||{};var b=b||5;var g=[];var h=h||{};for(var d=0,a=f.length;d<a&&g.length<b;d++){var e=f[d];if(e.uid in h){continue}if(!c){g.push(e);continue}if(e.username.indexOf(c)!==-1){g.push(e);continue}if(e.uid.indexOf(c)!==-1){g.push(e)}}return{users:g}},bindCommentsEvents:function(){var a=this;a.getAllCommenters();a.$others.delegate("p .btn-del","mouseenter",function(b){$(this).parent().addClass("mover")}).delegate("p .btn-del","mouseleave",function(b){$(this).parent().removeClass("mover")});if(!a.$text._tagsug_api){Do("tagsug",function(){a.$text.tagsug({max:5,customData:function(){return a.filteredCommenters.apply(a,arguments)},useUid:true})})}},like:function(a){var b=this;a.removeClass("btn");$.post_withck("/j/status/like",{sid:this.id},function(c){c=$.parseJSON(c);if(!c.r){a.text("已赞").attr({"data-action-type":"unlike","class":"btn btn-unlike"});b.updateCount(a,"like",1)}})},unlike:function(a){var b=this;$.post_withck("/j/status/unlike",{sid:this.id},function(c){c=$.parseJSON(c);if(!c.r){a.text("赞").attr({"data-action-type":"like","class":"btn btn-like"});b.updateCount(a,"like",-1)}})},showLikes:function(c){var b=this;var a=$('<div class="likers"><em></em> <span>赞</span></div>');if(c!==""){a.find("em").html(c);this.$others.find(".likers").remove().end().prepend(a)}},showComments:function(c){var d=this;d.$comments=d.$others.find(".comments");c.text("加载中").attr("data-action-type","hideComments");var b="";var a=d.$comments.find(".comments-items");$.getJSON("/j/status/comments",{sid:d.id},function(f){c.text("隐藏回应");var e=f.comments;d.showLikes(f.likers);a.html(e);d.$others.show();d.bindCommentsEvents()})},hideComments:function(b){var a=this.$comments.find("p").length;b.text((a?a:"")+"回应").attr("data-action-type","showComments");this.$others.hide()},addComment:function(){var c=this;var a=c.$node.find(".comment-text");var b=a.val();$.post_withck("/j/status/comments",{sid:c.id,text:b},function(d){d=$.parseJSON(d);c.$comments.find(".comments-items").append(d.comment)});a.val("").parent().addClass("comment-posted")},deleteComment:function(d){var e=d.attr("data-cid");var a=d.attr("data-sid");var c=confirm("确定要删除此回应吗？");var b=this.$node.find('input[name="ck"]').val();if(c){$.ajax({type:"DELETE",url:"/j/status/comments",data:{ck:b,cid:e,sid:a},success:function(){d.parents("p").remove()}})}},reshare:function(a){var b=this;a.removeClass("btn");$.post_withck("/j/status/reshare",{sid:this.id},function(c){c=$.parseJSON(c);if(c){a.text("已转播").attr({"data-action-type":"unreshare","data-reshare-id":c.reshare_id,"class":"btn btn-unreshare"}).addClass("btn")}})},unreshare:function(b){var c=this;var a=b.attr("data-reshare-id");$.post_withck("/j/status/unreshare",{sid:a},function(d){if(!d.r){b.text("转播").attr({"data-action-type":"reshare","class":"btn btn-reshare"}).removeAttr("data-reshare-id")}})},deleteStatus:function(c){var d=this,b=c.attr("data-widget-id"),a=confirm("确定要删除此条广播？");if(a){$.post_withck("/j/status/delete",{sid:this.id,wid:b},function(e){if(!e.r){d.$node.slideUp("normal",function(){$(this).remove()})}else{alert("删除失败，请刷新页面再试")}})}}};