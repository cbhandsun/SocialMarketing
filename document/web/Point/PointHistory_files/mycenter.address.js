G.app.mycenter=G.app.mycenter||{};G.app.mycenter.address={editArea:{_DEF_MOBILE_DESC:"手机号码",_DEF_PHONE1_DESC:"区号",_DEF_PHONE2_DESC:"电话号码",_DEF_PHONE3_DESC:"分机号(可选)",_editing:false,_location:null,edit:function(b){var c=G.app.mycenter.address,a=c.editArea;a.enableSave();a.show();if(b===false){a._editing=false;a.reset()}else{a._editing=b;a.disableSave();c.list.getOne(b,function(d){if(d===false){return}a.enableSave();a.setFields(d)})}},reset:function(){var a=G.app.mycenter.address.editArea;a.setFields({workplace:"",address:"",zipcode:"",name:"",mobile:"",phone:"",district:0})},discard:function(){var a=G.app.mycenter.address.editArea;a.reset();a.hide()},save:function(){var a=G.app.mycenter.address.editArea,b=G.logic.login.getLoginUid();a.disableSave();var c=a.getFields();if(c===false){a.enableSave();return false}if(a._editing===false){G.util.post("http://base.51buy.com/json.php?mod=address&act=add&uid="+b,c,function(d){if(d&&d.errno==0){a.hide();G.app.mycenter.address.list.set(d.data.aid,d.data);G.app.mycenter.address.print();G.app.mycenter.address.setTip("成功增加收货地址！","suc")}else{G.app.mycenter.address.setTip("对不起，增加收货地址失败，请稍后重试！","err")}a.enableSave()})}else{c.aid=a._editing;G.util.post("http://base.51buy.com/json.php?mod=address&act=modify&uid="+b,c,function(d){if(d&&d.errno==0){G.app.mycenter.address.list.getOne(a._editing,function(e){a.hide();G.app.mycenter.address.list.set(a._editing,$.extend(e,c));G.app.mycenter.address.print()});G.app.mycenter.address.setTip("成功修改收货地址！","suc")}else{G.app.mycenter.address.setTip("对不起，修改收货地址失败，请稍后重试！！","err")}a.enableSave()})}},hide:function(){$("#address_edit").hide().children().hide()},show:function(){$("#address_edit").show().children().show()},setLocation:function(b){var a=G.app.mycenter.address.editArea;a._location&&a._location.setLocation(b)},getLocId:function(){var a=G.app.mycenter.address.editArea;return a._location?a._location.getLocId():false},_fieldList:{workplace:["地址标注"],district:["地区",1],address:["详细地址",1],zipcode:["邮政编码"],name:["收货人",1],mobile:["手机号码",0],phone:["电话号码",0]},setFields:function(b){var a=G.app.mycenter.address.editArea,c=$("#address_edit");$.each(a._fieldList,function(d,f){if(d=="district"){a.setLocation(b.district||0)}else{if(d=="phone"){var g=b.phone.split("-");for(i=0;i<3;i++){var e=i+1;$("input[name=phone"+e+"]",c).focus().val(g[i]||"")}}else{$("input[name="+d+"]",c).focus().val(b[d]||"")}}});$("#bt_save").focus()},getFields:function(){var c={},a=G.app.mycenter.address.editArea,d=$("#address_edit"),b=true;$.each(a._fieldList,function(g,j){if(g=="district"){c[g]=a.getLocId();if(c[g]==0){G.ui.popup.showMsg("请选择地区");b=false;return false}}else{c[g]=$("input[name="+g+"]",d).val();var h=$("input[name=phone1]").val();var f=$("input[name=phone2]").val();var e=$("input[name=phone3]").val();c.phone="";if(g=="mobile"||g=="phone"){if(c.mobile==a._DEF_MOBILE_DESC){c.mobile=""}if(h==a._DEF_PHONE1_DESC){h=""}if(f==a._DEF_PHONE2_DESC){f=""}if(e==a._DEF_PHONE3_DESC){e=""}if(e){c.phone=h+"-"+f+"-"+e}else{if(f){c.phone=h+"-"+f}else{if(h){c.phone=h}else{c.phone=""}}}}else{if($.strlen(c.workplace)>8){G.ui.popup.showMsg("地址标注不能超过4个汉字或者8个字母，请重新填写");b=false;return false}if(j[1]==1&&!c[g]){G.ui.popup.showMsg(j[0]+"不能为空，请填写");b=false;return false}}}c[g]=$.trim(c[g])});if(b===false){return false}if($.strlen(c.address)>100){G.ui.popup.showMsg("详细地址不能超过50个汉字或者100个字母，请重新填写");return false}if($.strlen(c.name)>50){G.ui.popup.showMsg("收货人不能超过25个汉字或者50个字母，请重新填写");return false}if(c.zipcode&&(!G.logic.validate.checkChars(c.zipcode,4)||$.strlen(c.zipcode!=6))){G.ui.popup.showMsg("邮政编码填写有误，格式：200000，请重新填写");return false}if(!c.mobile&&!c.phone){G.ui.popup.showMsg("手机和电话号码两者至少填写一项");return false}else{if(c.mobile&&!G.logic.validate.checkMobilePhone(c.mobile)){G.ui.popup.showMsg("手机号码填写有误，格式：13612345678，请重新填写");return false}else{if(c.phone&&!G.logic.validate.checkTelephone(c.phone)){G.ui.popup.showMsg("固定电话填写有误，格式：021-61831107，请重新填写");return false}}}return c},_saveFn:function(){G.app.mycenter.address.editArea.save()},enableSave:function(){$("#bt_save").unbind("click.save").bind("click.save",G.app.mycenter.address.editArea._saveFn);$("#bt_save")[0].disabled=false},disableSave:function(){$("#bt_save").unbind("click.save");$("#bt_save")[0].disabled=true},init:function(){var b=G.app.mycenter.address,a=b.editArea,c=$("#address_edit");a._location=b.location.locSelection(0);$("#location_box").empty().append(a._location);a.disableSave();$("#bt_discard").click(function(){G.app.mycenter.address.editArea.discard()});$("#bt_add").click(function(){G.app.mycenter.address.editArea.edit(false)});G.ui.tips.swapInput({target:$("input[name=mobile]",c),defaultValue:a._DEF_MOBILE_DESC,blurClass:"nor"}).blur();G.ui.tips.swapInput({target:$("input[name=phone1]",c),defaultValue:a._DEF_PHONE1_DESC,blurClass:"nor"}).blur();G.ui.tips.swapInput({target:$("input[name=phone2]",c),defaultValue:a._DEF_PHONE2_DESC,blurClass:"nor"}).blur();G.ui.tips.swapInput({target:$("input[name=phone3]",c),defaultValue:a._DEF_PHONE3_DESC,blurClass:"nor"}).blur()}},list:{_data:false,get:function(a){var b=G.app.mycenter.address.list;a=$.isFunction(a)?a:$.noop;if(b._data!==false){return a(b._data)}var c=G.logic.login.getLoginUid();G.util.post("http://base.51buy.com/json.php?mod=address&act=get&uid="+c,{},function(d){if(d&&d.errno==0){b._data=d}a(d)})},getOne:function(c,a){var b=G.app.mycenter.address.list;a=$.isFunction(a)?a:$.noop;b.get(function(e){if(e&&e.errno==0){var d=false;$.each(e.data,function(g,f){if(f.aid==c){d=f;return false}});a(d)}else{a(false)}})},set:function(d,e){var b=G.app.mycenter.address.list;if(b._data&&b._data.errno==0){var c=-1,a=0;$.each(b._data.data,function(g,f){if(f&&f.aid==d){c=g;return false}a=g>a?g:a});if(c<0){b._data.data[a-0+1]=e}else{b._data.data[c]=e}}}},_printFn:function(d){var c=G.app.mycenter.address,b=[],a=$("#address_list").empty();if(d&&d.errno==0){$.each(d.data,function(e,f){if(!f){return}f=c._encode(f);f.district_chn=G.app.mycenter.address.location.getLocName(f.district);f.ifdefault_desc=f.sortfactor==1?"<strong>默认地址</strong>":'<a href="">设置为默认地址</a>';b.push(f)});if(b.length>0){a.html(G.ui.template.fillWithTPL("address_list",{list:b},"address_list_tpl","",true))}else{a.html('<tr><td colspan="4" style="width:100%" class="center">您还没有设置任何收货地址！<a href="#" name="add" onclick="return false">【增加收货地址】</a></td></tr>');$("a[name=add]",a).click(function(){G.app.mycenter.address.editArea.edit(false)})}}else{a.html('<tr><td colspan="4" style="width:100%" class="center">系统繁忙，请稍候再试！</td></tr>')}},print:function(){var a=G.app.mycenter.address;a.list.get(a._printFn)},remove:function(b){var a=G.app.mycenter.address;G.ui.popup.showMsg("是否确定删除，该操作无法恢复？",4,function(){var c=G.logic.login.getLoginUid();G.util.post("http://"+G.DOMAIN.BASE_ICSON_COM+"/json.php?mod=address&act=del&uid="+c,{aid:b},function(d){if(d&&d.errno==0){$.each(G.app.mycenter.address.list._data.data,function(f,e){if(e.aid==b){delete G.app.mycenter.address.list._data.data[f];return false}});G.app.mycenter.address.setTip("删除收货地址成功！","suc");if(a.editArea._editing==b){a.editArea.discard()}a.print()}else{G.app.mycenter.address.setTip("对不起，删除收货地址失败，请稍后重试！","err")}})},$.noop,$.noop,"删除","不删除")},setTip:function(b,a){if(a=="err"){a=1}else{if(a=="warn"){a=1}else{if(a=="suc"){a=3}}}G.ui.popup.showMsg(b,a)},location:{_loc:false,getLocInfo:function(b){if(!G.util.area){return false}var a=G.app.mycenter.address.location;if(a._loc===false){a._loc={};$.each(G.util.area,function(d,e){$.each(e.l,function(g,f){$.each(f.l,function(h,j){a._loc[h]=[j,d,e.n,g,f.n]})})})}var c=a._loc[b];if(!c){return false}return{name:c[0],provinceId:c[1],provinceName:c[2],cityId:c[3],cityName:c[4]}},locSelection:function(f){var b=['<select><option value="0">请选择</option>'];$.each(G.util.area,function(c,d){b.push('<option value="'+c+'">'+d.n+"</option>")});b.push('</select> <select><option value="0">请选择</option></select> <select><option value="0">请选择</option></select>');var a=$(b.join(""));var e=a.filter("select:eq(0)");var h=a.filter("select:eq(1)");var g=a.filter("select:eq(2)");e.change((function(d,j,c){return function(){var k=d.val();var l=['<option value="0">请选择</option>'];if(G.util.area[k]){$.each(G.util.area[k].l,function(n,m){l.push('<option value="'+n+'">'+m.n+"</option>")})}j.empty().html(l.join(""));j.hide()[0].style.display="";j.change()}})(e,h,g));h.change((function(d,j,c){return function(){var m=d.val();var p=j.val();var o=['<option value="0">请选择</option>'];if(G.util.area[m]&&G.util.area[m].l[p]){var n=$.extend({},G.util.area[m].l[p].l);var k=[];$.each(n,function(q,l){k.push({id:q,name:l})});k.sort(function(q,l){return q.name.toString().localeCompare(l.name.toString())});$.each(k,function(q,l){o.push('<option value="'+l.id+'">'+l.name+"</option>")});k=null}c.empty().html(o.join(""));c.hide()[0].style.display=""}})(e,h,g));a.setLocation=function(m){var k=$(this).filter("select:eq(0)"),n=$(this).filter("select:eq(1)"),l=$(this).filter("select:eq(2)");var j=G.app.mycenter.address.location.getLocInfo(m);if(j!==false){k.val(j.provinceId).change();setTimeout(function(){n.val(j.cityId).change();setTimeout(function(){l.val(m)},1)},1)}else{k.val(0);k.change()}};a.getLocId=function(){return $(this).filter("select:eq(2)").val()};a.setLocation(f);return a},getLocName:function(c){var b=G.app.mycenter.address.location;var a=b.getLocInfo(c);if(a===false){return""}return a.provinceName+a.cityName+a.name}},init:function(){var a=G.app.mycenter.address;a.editArea.init();a.print()},_encode:function(a){var b={};$.each(a,function(d,c){b[d]=typeof c=="string"?G.util.parse.encodeHtml(c):c});return b}};