(function(){var a={size:null,imgGutter:0,minHeight:null,maxHeight:null,itemSelector:"li",maxScale:1.5,maxRatio:2.5,minRatio:0.2,_defaultWidth:100,_defaultHeight:100,imgSelector:"img"};var b=function(d,c){this.node=d;this.options=c;this.node.data("photowall",this);this.render()};b.prototype={render:function(){var e=this;var d=e.options;var f=e.photos=e.node.find(d.imgSelector);if(!e.options.size){d.picInfo=e.collectPhotoInfo(e.photos)}var l=d.containerWidth=e.node.width();if(d.picInfo.totalWidth<l){return}var c=d.imgGutter;var k=this.getRefHeight([d.minHeight||d.picInfo.minHeight,d.maxHeight||d.picInfo.maxHeight],d.picInfo.ratio,l,c);var m=0;var h=0;var j=d.picInfo.ratio;var p=d.picInfo.size;var n=[];var g=[];while(h<d.picInfo.size.length){m+=k*j[h]+c;if(m>l){e.rowJustify(g,n,k);m=k*j[h]+c;g=[f.eq(h)];n=[p[h]]}else{g.push(f.eq(h));n.push(p[h])}h++}e.rowJustify(g,n,k)},rowJustify:function(f,l,c){var g=this.options.imgGutter;var h=this.options.containerWidth;var d=[];var k;var m=[];var j=0;var i;$(l).each(function(n){var o=this[0]/this[1];j+=c*o+g;m.push([c*o,c])});if(j<h){i=h-j;$(m).each(function(n){var q=this[0];var r=this[1];var p=q/r;var o=(q+g)/j*i;q=q+o;r=k?k:(k=q/p);d.push([Math.round(q),Math.round(r)])})}else{d=m}var e=this;$(f).each(function(n){e.setItemSize(this,d[n])})},getRefHeight:function(p,j,k,c){var f=p[0];var o=p[1];var l;var m;var d=+new Date;var i;var g;var n;for(;f<=o;f++){l=0;m=0;while(l<=k&&m<j.length){n=j[m]*f+c;if(l+n>k){l=n}else{l+=n}m++}g=k-l;if(g<d){d=g;i=f}}if(d>k/2){return this.getRefHeight([p[1],p[1]*1.5],j,k,c)}return i},setCols:function(c){this.reset();this.render()},setWidth:function(c){this.reset();this.node.width(c);this.render()},reset:function(){if(!this.photos){return}this.options.size=null;this.photos.removeAttr("width");this.photos.removeAttr("height");delete this.photos;return this},collectPhotoInfo:function(i){var e=[];var f=[];var h=+new Date;var g=0;var c=0;var i=this.photos;var d=this.options;i.each(function(){var j=this.offsetWidth||d._defaultWidth;var l=this.offsetHeight||d._defaultHeight;var k=[j,l];var m=j/l;if(m>d.maxRatio){m=1;k=[j,j]}else{if(m<d.minRatio){j=l/2;k=[j,l];m=j/l}}$(this).data({width:j,height:l});c+=j;h=Math.min(h,l);g=Math.max(h,l);e.push(k);f.push(m)});return{size:e,ratio:f,minHeight:h,maxHeight:g,totalWidth:c}},setItemSize:function(e,f){var d=e.data();var c=f[0];var g=f[1];var i="";if(d.width/d.height>this.options.maxRatio){g=c/(d.width/d.height);i=(f[1]-g)/2+"px 0"}e.attr({width:c,height:g}).css("padding",i).closest(this.options.itemSelector).css({width:c,overflow:"hidden"});if(c/e.data("width")>this.options.maxScale){var j=e.data("origin-src");if(j){e.attr("src",j)}}return e}};$.fn.photoWall=function(c){c=$.extend(a,c);return new b($(this),c)}})();