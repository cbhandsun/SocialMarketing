var o={},PEOPLE_ID="",currTagId="",totallen=16,newGroupNum=0,groupNameArr=[],isDuplicate=false,mlist=$(".menu-list"),olist=$(".group-opts-list"),sglist=$(".set-group-list"),sgarrow=$(".user-group-arrow"),addGroup=$("#add-new-group"),TEMPL_NEW_TAG='<li><a href="?tag={ID}">{NAME}</a></li>',TEMPL_MENU_LIST='<li><a href="?tag=0">全部</a></li>{CUSTOM_TAGS}<li class="last"><a href="?tag=2">未分组</a></li>',TEMPL_NEW_GROUP_ITEM='<li><input type="checkbox" id="{GID}" value="{GID}" {CHECKED}><label for="{GID}">{GNAME}</label></li>',TEMPL_SET_LIST_ITEMS='{CUSTOM_ITEMS}<li class="last"><span class="create-new">新分组</span></li>',TEMPL_GROUP_OPTS='<ul class="group-opts-list"><li id="del-group">删除分组</li><li id="rename-group">改组名</li></ul>',TEMPL_FRIEND_TIPS='<span class="tips">(可看仅朋友可见内容)</span>',TEMPL_EDIT_ICON='&nbsp;<em class="icon-edit"></em>',TEMPL_TIPS='<span class="tips tlimit">{TIPS}</span>',CSS_LAST_ITEM=".set-group-list .last",CSS_INPUT_CREATE=".input-create",CSS_ARROW_SELECT="arrow-select",CSS_LOADER=".gray-loader",CSS_SET_GROUP_LIST=".set-group-list",CSS_EM_TIPS=".tlimit",TXT_DUP_NAME="已有同名分组",TXT_NULL_NAME="请输入分组名",TXT_BAN_WORDS="分组名称含有被禁止的内容",isIE6=($.browser.msie&&$.browser.version==="6.0")?true:false,collectGroupName=function(){var a=$("#db-timeline-hd a").toArray();$.each(a,function(c,b){groupNameArr[c]=$.trim($(b).text())})},countNum=function(){var a=$("input[type=checkbox]:checked").length;if(a>0){$(".sel-wrapper .user-rs").html("加入"+a+"个分组")}else{$(".sel-wrapper .user-rs").html("加入分组")}},changeGroupShow=function(f){var c=f.parents(".user-group-arrow").prev(".user-rs"),b=f.closest(CSS_SET_GROUP_LIST).children().children(":checked"),a=b.length,e=b.toArray(),d=$.map(e,function(g){return $(g).next().text().escapeHTML()});if(a>0){c.html(d.join(", ").substring(0,totallen)).show();if(d.join(", ").length>=totallen){c.append("...")}}else{c.text("未分组")}},createNewGroup=function(d,b,c,a){$.each(groupNameArr,function(f,e){if(c===e||c==="全部"||c==="未分组"){isDuplicate=true;if(!$(CSS_EM_TIPS,d).length){$(CSS_INPUT_CREATE,d).after(TEMPL_TIPS.replace("{TIPS}",TXT_DUP_NAME))}else{$(CSS_EM_TIPS,d).text(TXT_DUP_NAME)}return false}else{isDuplicate=false}});if(c&&!isDuplicate){$(CSS_EM_TIPS).remove();$.post_withck("/j/contact/newtag",{name:c,people:b},function(k){if(k.result){var h=[],i=[],m="",g="",l="",j=k.data.newtag.id,f=k.data.newtag.name;if(mlist.length){$.each(k.data.all,function(p,n){h[p]=TEMPL_NEW_TAG.replace("{ID}",n.id).replace("{NAME}",n.name.escapeHTML())});mlist.html(TEMPL_MENU_LIST.replace("{CUSTOM_TAGS}",h.join("")));m=$(".menu-list a:contains("+currGroupName+")");m.parent().addClass("on");if(currGroupName!=="全部"&&currGroupName!=="朋友"&&currGroupName!=="未分组"){m.append(TEMPL_EDIT_ICON).after(TEMPL_GROUP_OPTS)}}$.each(k.data.all,function(p,n){i[p]=TEMPL_NEW_GROUP_ITEM.replace(/{GID}/g,n.id).replace("{GNAME}",n.name.escapeHTML()).replace("{CHECKED}",n.status?'checked="checked"':"")});$(CSS_SET_GROUP_LIST,d).html(TEMPL_SET_LIST_ITEMS.replace("{CUSTOM_ITEMS}",i.join("")));$(CSS_SET_GROUP_LIST+" li:first",d).append(TEMPL_FRIEND_TIPS);if($(CSS_SET_GROUP_LIST).length>1){l=$("#"+j).parent().next().children("label").text()||"";g=TEMPL_NEW_GROUP_ITEM.replace(/{GID}/g,j).replace(/{GNAME}/g,f.escapeHTML()).replace("{CHECKED}","");if(l){$(CSS_SET_GROUP_LIST+' li:contains("'+l+'")').before(g)}else{$(CSS_LAST_ITEM).before(g)}$(CSS_SET_GROUP_LIST+" input[id="+j+"]",d).eq(1).parent().remove()}newGroupNum=$(CSS_SET_GROUP_LIST+" input[type=checkbox]",d).length;if(newGroupNum>=a){$(CSS_LAST_ITEM).remove()}var e=$(d).children().children("li:first");if($(".custom-popwin").length){countNum(e)}else{changeGroupShow(e)}collectGroupName()}else{if(k.msg==="ban"){if(!$(CSS_EM_TIPS,d).length){$(CSS_INPUT_CREATE,d).after(TEMPL_TIPS.replace("{TIPS}",TXT_BAN_WORDS))}else{$(CSS_EM_TIPS,d).text(TXT_BAN_WORDS)}}}},"json")}else{if(!c){if(!$(CSS_EM_TIPS,d).length){$(CSS_INPUT_CREATE,d).after(TEMPL_TIPS.replace("{TIPS}",TXT_NULL_NAME))}else{$(CSS_EM_TIPS,d).text(TXT_NULL_NAME)}}}};collectGroupName();if(isIE6){$(CSS_SET_GROUP_LIST+' li:not(".last")').hover(function(){$(this).addClass("hover")},function(){$(this).removeClass("hover")})};